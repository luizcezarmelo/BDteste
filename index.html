<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Agenda com Notificações</title>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
<h1>Agenda com Lembretes</h1>

<input type="date" id="dataInput">
<div id="compromissos"></div>
<button id="adicionar">Adicionar Compromisso</button>

<script>
  // --- CONFIGURAÇÃO DO FIREBASE ---
  const firebaseConfig = {
    apiKey: "AIzaSyBiikcagIm1p7wJG6DsHijkvdy1fpDBn8Y",
    authDomain: "bd-teste-c931c.firebaseapp.com",
    databaseURL: "https://bd-teste-c931c-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "bd-teste-c931c",
    storageBucket: "bd-teste-c931c.firebasestorage.app",
    messagingSenderId: "270308100761",
    appId: "1:270308100761:web:ae34fde6d5ae86b67b0608"
  };
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  const dataInput = document.getElementById("dataInput");
  const compromissosDiv = document.getElementById("compromissos");
  const btnAdicionar = document.getElementById("adicionar");

  // --- FUNÇÃO PARA ADICIONAR COMPROMISSO ---
  function adicionarCompromisso(texto = "", hora = "", lembrete = false) {
    const div = document.createElement("div");
    div.classList.add("commitment");
    div.innerHTML = `
      <input type="time" value="${hora}">
      <input type="text" placeholder="Compromisso" value="${texto}">
      <label>
        <input type="checkbox" class="lembrete-checkbox" ${lembrete ? "checked" : ""}>
        Lembrete
      </label>
    `;
    compromissosDiv.appendChild(div);
  }

  btnAdicionar.addEventListener("click", () => adicionarCompromisso());

  // --- SALVAR AGENDA NO FIREBASE ---
  function salvarAgenda() {
    const compromissos = [];
    compromissosDiv.querySelectorAll(".commitment").forEach(div => {
      const hora = div.querySelector('input[type="time"]').value;
      const texto = div.querySelector('input[type="text"]').value;
      const lembrete = div.querySelector('.lembrete-checkbox').checked;
      compromissos.push({ hora, texto, lembrete });
    });
    database.ref("agenda/" + dataInput.value).set(compromissos);
  }

  // --- CARREGAR AGENDA ---
  function carregarAgenda() {
    compromissosDiv.innerHTML = "";
    database.ref("agenda/" + dataInput.value).once("value", snapshot => {
      const dados = snapshot.val();
      if (dados) {
        dados.forEach(c => adicionarCompromisso(c.texto, c.hora, c.lembrete));
      }
    });
  }

  dataInput.addEventListener("change", carregarAgenda);

  // --- PERGUNTA PERMISSÃO PARA NOTIFICAÇÕES ---
  if ("Notification" in window) {
    Notification.requestPermission().then(perm => {
      if (perm !== "granted") {
        alert("As notificações estão desativadas. Ative para receber lembretes.");
      }
    });
  }

  // --- VERIFICA LEMBRETES A CADA 20s ---
  setInterval(() => {
    const hoje = new Date().toISOString().split('T')[0];
    if (dataInput.value !== hoje) return;

    const agora = new Date();
    const horaAtual = agora.getHours().toString().padStart(2, '0') + ':' + agora.getMinutes().toString().padStart(2, '0');

    compromissosDiv.querySelectorAll(".commitment").forEach(div => {
      const inputHora = div.querySelector('input[type="time"]');
      const inputTexto = div.querySelector('input[type="text"]');
      const checkLembrete = div.querySelector('.lembrete-checkbox');

      if (checkLembrete.checked && inputHora.value && horaAtual >= inputHora.value && inputTexto.value.trim() !== '') {
        // Notificação do navegador
        if (Notification.permission === "granted") {
          new Notification("Lembrete", { body: inputTexto.value });
        }
        checkLembrete.checked = false;
        salvarAgenda();
      }
    });
  }, 5000);

  // --- INICIA DATA DE HOJE ---
  dataInput.value = new Date().toISOString().split('T')[0];
  carregarAgenda();
</script>

</body>
</html>
