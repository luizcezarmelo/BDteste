<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agenda do Fofo</title>
  <style>
    * { box-sizing: border-box; }
    :root{
      --b: #0f172a;      /* slate-900 */
      --fg:#0b1324;      /* text */
      --muted:#6b7280;   /* gray-500 */
      --bd:#e5e7eb;      /* gray-200 */
      --pri:#2563eb;     /* blue-600 */
      --pri-2:#1e40af;   /* blue-800 */
      --ok:#16a34a;      /* green-600 */
      --warn:#ea580c;    /* orange-600 */
      --bg:#ffffff;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue','Noto Sans',Arial,sans-serif;background:var(--bg);color:var(--fg)}
    .container{display:flex;flex-direction:column}
    @media(min-width:900px){.container{flex-direction:row;min-height:100vh}}
    .left-panel,.right-panel{padding:20px}
    .left-panel{flex:2;border-right:1px solid var(--bd)}
    .right-panel{flex:1}
    h1, h2, h3 {margin:0 0 10px 0}
    .calendar-section{margin:12px 0;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .day-nav{display:flex;gap:8px;align-items:center;margin:0 0 12px 0}
    button{cursor:pointer;border:1px solid var(--bd);background:#f8fafc;border-radius:8px;padding:8px 12px}
    button:hover{background:#eef2ff}
    input[type="text"], input[type="date"], input[type="password"], textarea {padding:8px;border:1px solid var(--bd);border-radius:6px;width:100%}
    .actions{display:flex;gap:10px;margin:10px 0;flex-wrap:wrap}
    .search-area{display:flex;gap:6px;align-items:center;margin:8px 0;flex-wrap:wrap}
    .search-area input{flex:1;min-width:160px}
    .search-results{border:1px solid var(--bd);border-radius:8px;max-height:220px;overflow:auto}
    .search-results div{padding:8px 10px;border-bottom:1px solid var(--bd);cursor:pointer}
    .search-results div:last-child{border-bottom:none}
    .search-results div:hover{background:#f1f5f9}
    .commitment{display:grid;grid-template-columns:92px 1fr auto auto;gap:6px;align-items:center;padding:8px;border:1px solid var(--bd);border-radius:10px;margin-bottom:8px}
    .commitment input[type="time"]{padding:6px;border:1px solid var(--bd);border-radius:6px;width:100%}
    .commitment .ok{border-color:#c7f0cf;background:#ecfdf5}
    .commitment .del{border-color:#ffd7d7;background:#fff1f2}
    .done{text-decoration:line-through;color:#6b7280}
    .checked{background:#e7f0ff} /* Mantido do original para a fun√ß√£o de copiar */
    .destaque{outline:3px solid #fde68a;background:#fffbeb}
    .muted{color:var(--muted);font-size:.9rem}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tag{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;border:1px solid var(--bd);border-radius:999px;padding:6px 10px;font-size:.85rem}
    .pill{background:#ecfeff;border:1px solid #bae6fd;border-radius:999px;padding:2px 8px;font-size:.75rem}
    .panel{border:1px solid var(--bd);border-radius:12px;padding:12px; margin-bottom: 12px;}
    /* LOGIN */
    #login-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#f3f4f6;z-index:1000}
    #login-card{background:#fff;border:1px solid var(--bd);border-radius:16px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.08);min-width:320px;max-width:92vw}
    #login-card .msg{min-height:18px;font-size:.9rem}
    #toggle-password{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:transparent;border:none;font-size:1rem;cursor:pointer;padding:0}
    .relogio{font-variant-numeric:tabular-nums}
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
  <div id="login-screen">
    <div id="login-card">
      <h2 id="login-title">Acesso Restrito</h2>
      <p class="muted" id="login-sub">Entre com a senha para continuar.</p>
      <div style="position:relative;margin:8px 0 6px 0">
        <input type="password" id="password-input" placeholder="Digite a senha" onkeypress="handleKeyPress(event)" />
        <button id="toggle-password" title="Mostrar/ocultar" onclick="togglePasswordVisibility()">üëÅÔ∏è</button>
      </div>
      <div id="error-message" class="msg" style="color:#dc2626; display:none;">Senha incorreta.</div>
      <div class="row">
          <button id="login-button" onclick="checkPassword()">Entrar</button>
      </div>
      <div id="setup-message" style="display: none; margin-top: 15px;">
        <p class="muted">Ainda n√£o h√° senha. Defina uma para continuar.</p>
        <button id="set-password-button" onclick="setPassword()">Definir senha</button>
      </div>
      <div class="muted" style="margin-top:8px">Dica: Enter confirma.</div>
    </div>
  </div>

  <div class="container" id="main-content" style="display: none;">
    <div class="left-panel">
      <h1>Agenda do Fofo</h1>
      <div class="calendar-section">
        <input type="date" id="dataSelecionada" style="width: auto;">
        <button id="hojeBtn" title="Hoje">üìÖ Hoje</button>
      </div>
      <div class="day-nav">
        <button id="prevDayBtn">‚óÄ Anterior</button>
        <button id="nextDayBtn">Pr√≥ximo ‚ñ∂</button>
      </div>
      <div class="actions">
        <button id="novoBtn">Novo</button>
        <button id="copiarBtn">Copiar</button>
        <button id="colarBtn">Colar</button>
        <button id="exportarBtn">Exportar TXT</button>
      </div>
      <div id="agenda"></div>
    </div>
    <div class="right-panel">
      <div class="panel">
        <h2>Validador de CPF</h2>
        <div class="row">
          <input type="text" id="cpf" placeholder="Digite o CPF" style="width: auto; flex:1;">
          <button onclick="limparCPF()" title="Limpar CPF">‚ùå</button>
          <button onclick="copiarCPF()">Copiar</button>
        </div>
        <p id="cpfStatus" class="muted"></p>
      </div>

      <div class="panel">
        <h3>üîç Pesquisa</h3>
        <div class="search-area">
          <input type="text" id="search" placeholder="Pesquisar...">
          <button onclick="limparBusca()">Limpar</button>
        </div>
        <div id="searchResults" class="search-results"></div>
      </div>

      <div class="panel">
        <h3>üìù Lembretes:</h3>
        <textarea id="notasFixas" rows="15"></textarea>
      </div>
    </div>
  </div>

<script>
    // --- L√ìGICA DE LOGIN ORIGINAL (sem altera√ß√µes) ---
    const PASSWORD_NODE = 'appPassword';
    const mainContent = document.getElementById('main-content');
    const loginScreen = document.getElementById('login-screen');
    const passwordInput = document.getElementById('password-input');
    const errorMessage = document.getElementById('error-message');
    const togglePasswordBtn = document.getElementById('toggle-password');
    const setupMessage = document.getElementById('setup-message');
    const loginTitle = document.getElementById('login-title');
    const loginSub = document.getElementById('login-sub');
    
    const firebaseConfig = {
      apiKey: "AIzaSyDQOGFiqafMZh0ha6XW62P1DpIKJE8TBYc",
      authDomain: "agenda-online-7b71c.firebaseapp.com",
      databaseURL: "https://agenda-online-7b71c-default-rtdb.firebaseio.com",
      projectId: "agenda-online-7b71c",
      storageBucket: "agenda-online-7b71c.appspot.com",
      messagingSenderId: "28125733214",
      appId: "1:28125733214:web:162d1cce5d14f55c24afcf"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let correctPassword = null;

    async function loadPassword() {
        const snapshot = await database.ref(PASSWORD_NODE).once('value');
        correctPassword = snapshot.val();
        if (correctPassword) {
            setupMessage.style.display = 'none';
            loginTitle.textContent = 'Acesso Restrito';
            loginSub.textContent = 'Entre com a senha para continuar.';
            document.getElementById('login-button').style.display = 'block';
        } else {
            setupMessage.style.display = 'block';
            loginTitle.textContent = 'Configurar Senha';
            loginSub.textContent = 'Defina uma senha para habilitar o acesso.';
            document.getElementById('login-button').style.display = 'none';
            passwordInput.placeholder = 'Defina uma nova senha';
        }
        loginScreen.style.display = 'flex';
    }

    function setPassword() {
        const newPassword = passwordInput.value;
        if (newPassword && newPassword.trim() !== '') {
            database.ref(PASSWORD_NODE).set(newPassword).then(() => {
                alert('Senha definida com sucesso!');
                loadPassword();
                passwordInput.value = '';
                passwordInput.placeholder = 'Digite a senha';
            }).catch(error => {
                console.error("Erro ao salvar a senha:", error);
                alert("Ocorreu um erro. Tente novamente.");
            });
        } else {
            alert('A senha n√£o pode ser vazia.');
        }
    }

    function checkPassword() {
        const enteredPassword = passwordInput.value;
        if (enteredPassword === correctPassword) {
            showMainContent();
        } else {
            errorMessage.style.display = 'block';
            passwordInput.select();
        }
    }

    function showMainContent() {
      loginScreen.style.display = 'none';
      mainContent.style.display = 'flex';
      carregarAgenda();
      carregarNotasFixas();
    }

    function togglePasswordVisibility() {
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        togglePasswordBtn.textContent = 'üôà';
      } else {
        passwordInput.type = 'password';
        togglePasswordBtn.textContent = 'üëÅÔ∏è';
      }
    }

    function handleKeyPress(event) {
        errorMessage.style.display = 'none';
        if (event.key === 'Enter') {
            if (correctPassword) {
                checkPassword();
            } else {
                setPassword();
            }
        }
    }

    window.addEventListener('load', () => {
        loadPassword();
    });
    // --- FIM DA L√ìGICA DE LOGIN ---

    // --- L√ìGICA PRINCIPAL DA APLICA√á√ÉO (sem altera√ß√µes) ---
    const agendaEl = document.getElementById('agenda');
    const searchEl = document.getElementById('search');
    const searchResultsEl = document.getElementById('searchResults');
    const dataInput = document.getElementById('dataSelecionada');
    const novoBtn = document.getElementById('novoBtn');
    const copiarBtn = document.getElementById('copiarBtn');
    const colarBtn = document.getElementById('colarBtn');
    const exportarBtn = document.getElementById('exportarBtn');
    const hojeBtn = document.getElementById('hojeBtn');
    const prevDayBtn = document.getElementById('prevDayBtn');
    const nextDayBtn = document.getElementById('nextDayBtn');
    const notasFixasEl = document.getElementById('notasFixas');

    const maxCompromissos = 20;
    let bufferCopiados = [];

    dataInput.value = new Date().toISOString().split('T')[0];

    dataInput.addEventListener('change', carregarAgenda);
    novoBtn.addEventListener('click', adicionarCompromisso);
    copiarBtn.addEventListener('click', copiarCompromissos);
    colarBtn.addEventListener('click', colarCompromissos);
    exportarBtn.addEventListener('click', () => exportarParaTXT(dataInput.value));
    hojeBtn.addEventListener('click', () => {
      const hoje = new Date().toISOString().split('T')[0];
      dataInput.value = hoje;
      carregarAgenda();
    });
    prevDayBtn.addEventListener('click', () => {
      const d = new Date(dataInput.value);
      d.setDate(d.getDate() - 1);
      dataInput.value = d.toISOString().split('T')[0];
      carregarAgenda();
    });
    nextDayBtn.addEventListener('click', () => {
      const d = new Date(dataInput.value);
      d.setDate(d.getDate() + 1);
      dataInput.value = d.toISOString().split('T')[0];
      carregarAgenda();
    });
    searchEl.addEventListener('input', pesquisarCompromisso);

    let debounceTimer;
    function salvarComDelay() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => salvarAgenda(), 1000);
    }

    async function carregarAgenda() {
      const data = dataInput.value;
      agendaEl.innerHTML = '';
      const section = document.createElement('div');
      section.className = 'date-section';
      section.dataset.data = data;
      const compromissos = document.createElement('div');
      compromissos.className = 'commitments';
      const snapshot = await database.ref('agenda/' + data).once('value');
      let dadosSalvos = snapshot.val() || [];
      while (dadosSalvos.length < 15) dadosSalvos.push({ texto: '', hora: '', tachado: false, selecionado: false });
      dadosSalvos.forEach(item => compromissos.appendChild(criarCampoCompromisso(item)));
      section.appendChild(compromissos);
      agendaEl.appendChild(section);
    }

    function salvarAgenda() {
      const data = dataInput.value;
      const section = document.querySelector('.date-section');
      if (!section) return;
      const textos = [];
      section.querySelectorAll('.commitment').forEach(div => {
        const input = div.querySelector('input[type=text]');
        textos.push({
          texto: input.value,
          hora: '',
          tachado: input.classList.contains('done'),
          selecionado: div.classList.contains('checked') // L√≥gica de copiar/colar usa a classe 'checked'
        });
      });
      database.ref('agenda/' + data).set(textos);
    }

    // --- FUN√á√ÉO DE CRIA√á√ÉO DO ITEM DA AGENDA (HTML alterado, L√ìGICA preservada) ---
    function criarCampoCompromisso(item = { texto: '', hora: '', tachado: false, selecionado: false }) {
      const div = document.createElement('div');
      div.className = 'commitment';
      // A classe 'checked' √© usada pela fun√ß√£o copiar/colar original
      if (item.selecionado) {
        div.classList.add('checked');
      }

      const hora = document.createElement('input');
      hora.type = 'time';
      hora.disabled = true; // Desabilitado pois a l√≥gica original n√£o usa tempo
      
      const input = document.createElement('input');
      input.type = 'text';
      input.value = item.texto;
      if (item.tachado) input.classList.add('done');
      
      input.addEventListener('input', salvarComDelay);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const allInputs = [...document.querySelectorAll('.commitment input[type=text]')];
          const idx = allInputs.indexOf(input);
          const next = allInputs[idx + 1];
          if (next) next.focus();
        }
      });
      
      const okBtn = document.createElement('button');
      okBtn.className = 'ok';
      okBtn.title = 'Concluir';
      okBtn.textContent = '‚úî';
      okBtn.onclick = () => {
        input.classList.toggle('done');
        // A fun√ß√£o de copiar usa a classe .checked no div pai.
        // Ao concluir, vamos marcar como "selecionado" para a l√≥gica de c√≥pia ignor√°-lo.
        div.classList.toggle('checked', input.classList.contains('done'));
        salvarAgenda();
      };
      
      const delBtn = document.createElement('button');
      delBtn.className = 'del';
      delBtn.title = 'Limpar';
      delBtn.textContent = 'üóë';
      delBtn.onclick = () => {
        input.value = '';
        input.classList.remove('done');
        div.classList.remove('checked');
        salvarAgenda();
      };
      
      // Monta o elemento na nova ordem visual
      div.appendChild(hora);
      div.appendChild(input);
      div.appendChild(okBtn);
      div.appendChild(delBtn);
      
      // Adiciona o listener para a fun√ß√£o de copiar/colar (que usa a classe no div)
      div.addEventListener('click', (e) => {
        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
             div.classList.toggle('checked');
             salvarAgenda();
        }
      });

      return div;
    }

    function adicionarCompromisso() {
      const compromissos = document.querySelector('.commitments');
      if (compromissos && compromissos.children.length < maxCompromissos) {
        const novoCampo = criarCampoCompromisso();
        compromissos.appendChild(novoCampo);
        novoCampo.querySelector('input[type=text]').focus();
      }
    }

    async function pesquisarCompromisso() {
        const termo = searchEl.value.trim().toLowerCase();
        searchResultsEl.innerHTML = '';
        if (termo.length < 3) return;
        const snapshot = await database.ref('agenda').once('value');
        const todasAsAgendas = snapshot.val();
        if (!todasAsAgendas) {
            searchResultsEl.innerHTML = '<div>Nenhum resultado.</div>'; return;
        }
        const resultados = [];
        for (const data in todasAsAgendas) {
            const dadosDoDia = todasAsAgendas[data] || [];
            dadosDoDia.forEach((item, index) => {
                if (item.texto && item.texto.toLowerCase().includes(termo)) {
                    resultados.push({ data, index, item });
                }
            });
        }
        if (resultados.length > 0) {
            resultados.sort((a,b)=> a.data.localeCompare(b.data));
            resultados.forEach(({ data, index, item }) => {
                const divResultado = document.createElement('div');
                divResultado.textContent = `${data} - ${item.texto}`;
                divResultado.onclick = () => {
                    dataInput.value = data;
                    carregarAgenda().then(() => {
                        const compromisso = agendaEl.querySelectorAll('.commitment')[index];
                        if (compromisso) {
                            compromisso.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            compromisso.classList.add('destaque');
                            setTimeout(() => compromisso.classList.remove('destaque'), 2000);
                        }
                    });
                };
                searchResultsEl.appendChild(divResultado);
            });
        } else {
            const div = document.createElement('div');
            div.textContent = 'Nenhum resultado.';
            searchResultsEl.appendChild(div);
        }
    }

    function limparBusca() {
      searchEl.value = '';
      searchResultsEl.innerHTML = '';
    }

    async function exportarParaTXT(data) {
        const snapshot = await database.ref('agenda/' + data).once('value');
        const dados = snapshot.val() || [];
        let conteudo = 'Agenda de ' + data + '\n\n';
        dados.forEach((item, i) => {
            if (item.texto) {
            conteudo += (i + 1) + '. ' + item.texto + (item.tachado ? ' (‚úî Conclu√≠do)' : '') + '\n';
            }
        });
        const blob = new Blob([conteudo], { type: 'text/plain;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `agenda_${data}.txt`;
        a.click();
    }

    function copiarCompromissos() {
      bufferCopiados = [];
      const section = document.querySelector('.date-section');
      if (!section) return;
      const compromissos = section.querySelectorAll('.commitment');
      compromissos.forEach(div => {
        if (div.classList.contains('checked') && !div.querySelector('input[type=text]').classList.contains('done')) {
          bufferCopiados.push(div.querySelector('input[type=text]').value);
          div.querySelector('input[type=text]').classList.add('done');
        }
      });
      salvarAgenda();
    }

    function colarCompromissos() {
      if (!bufferCopiados.length) return;
      const compromissosDiv = document.querySelector('.commitments');
      if (!compromissosDiv) return;
      let idxBuffer = 0;
      function encontrarOuAdicionarCampoVazio() {
        const vazio = [...compromissosDiv.children].find(div => !div.querySelector('input[type=text]').value);
        if (vazio) return vazio;
        if (compromissosDiv.children.length < maxCompromissos) {
          const novo = criarCampoCompromisso();
          compromissosDiv.appendChild(novo);
          return novo;
        }
        return null;
      }
      while (idxBuffer < bufferCopiados.length) {
        const campo = encontrarOuAdicionarCampoVazio();
        if (!campo) break;
        const input = campo.querySelector('input[type=text]');
        input.value = bufferCopiados[idxBuffer++];
        input.classList.remove('done');
        campo.classList.remove('checked');
      }
      salvarAgenda();
    }

    function validarCPF(cpf) {
      cpf = (cpf||'').replace(/\D/g,'');
      if (cpf.length!==11 || /^(\d)\1{10}$/.test(cpf)) return false;
      let soma=0, resto;
      for(let i=1;i<=9;i++) soma += parseInt(cpf[i-1])*(11-i);
      resto = (soma*10)%11; if(resto===10||resto===11) resto=0;
      if (resto !== parseInt(cpf[9])) return false;
      soma=0;
      for(let i=1;i<=10;i++) soma += parseInt(cpf[i-1])*(12-i);
      resto = (soma*10)%11; if(resto===10||resto===11) resto=0;
      return resto === parseInt(cpf[10]);
    }
    
    document.getElementById('cpf').addEventListener('input', () => {
      const raw = document.getElementById('cpf').value.replace(/\D/g, '');
      const status = document.getElementById('cpfStatus');
      const valido = validarCPF(raw);
      status.textContent = valido ? 'CPF v√°lido' : 'CPF inv√°lido';
      status.style.color = valido ? 'var(--pri)' : '#dc2626';
    });

    function copiarCPF() {
      let raw = document.getElementById('cpf').value.replace(/\D/g, '');
      if (validarCPF(raw)) {
        let formatado = raw.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
        navigator.clipboard.writeText(formatado);
      }
    }

    function limparCPF() {
      document.getElementById('cpf').value = '';
      document.getElementById('cpfStatus').textContent = '';
    }

    async function carregarNotasFixas() {
        const snapshot = await database.ref('notasFixas').once('value');
        notasFixasEl.value = snapshot.val() || '';
    }
    notasFixasEl.addEventListener('input', () => {
        database.ref('notasFixas').set(notasFixasEl.value);
    });

    document.addEventListener('input', (e) => {
      if (e.target.matches('input[type="text"], textarea')) {
        const pos = e.target.selectionStart;
        e.target.value = e.target.value.toUpperCase();
        e.target.setSelectionRange(pos, pos);
      }
    });
</script>
</body>
</html>
