function notificar(msg){
  if ("Notification" in window && Notification.permission === "granted") {
    new Notification("Agenda do Fofo", { body: msg });
  }
  alert(msg); // garante que aparece mesmo se o navegador estiver minimizado
}

async function checarAlarmes(){
  const hoje = hojeISO();
  const agora = new Date();
  const hhmmAtual = agora.getHours().toString().padStart(2,'0') + ":" + 
                    agora.getMinutes().toString().padStart(2,'0');

  if (ui.dataInput.value !== hoje) {
    // mesmo que a tela esteja em outro dia, alarme considera apenas HOJE
    const snap = await get(child(ref(db), `agenda/${hoje}`));
    if (!snap.exists()) return;
    const lista = snap.val() || [];
    let houveAlteracao = false;

    for (let i=0;i<lista.length;i++){
      const c = lista[i];
      if (!c || !c.hora || !c.texto) continue;
      if (!c.avisadoEm && c.hora === hhmmAtual) {
        notificar(`Lembrete (${c.hora}): ${c.texto}`);
        c.avisadoEm = Date.now();
        lista[i] = c;
        houveAlteracao = true;
      }
    }
    if (houveAlteracao) await set(ref(db, `agenda/${hoje}`), lista);
    return;
  }

  // Se a tela estÃ¡ em HOJE, use os dados locais
  let mudou = false;
  for (let i=0;i<dadosDia.length;i++){
    const c = dadosDia[i];
    if (!c || !c.hora || !c.texto) continue;
    if (!c.avisadoEm && c.hora === hhmmAtual) {
      notificar(`Lembrete (${c.hora}): ${c.texto}`);
      c.avisadoEm = Date.now();
      mudou = true;
    }
  }
  if (mudou) salvarAgenda(true);
}
