<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda do Fofo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #loginDiv, #agendaDiv { max-width: 600px; margin: auto; }
    #agendaDiv { display: none; }
    .compromisso { display: flex; gap: 10px; margin: 5px 0; }
    .compromisso input { flex: 1; }
    #saveIcon {
      position: fixed;
      top: 10px;
      right: 10px;
      font-size: 22px;
      display: none;
    }
  </style>
</head>
<body>
  <div id="loginDiv">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email"><br><br>
    <input type="password" id="password" placeholder="Senha"><br><br>
    <button onclick="login()">Entrar</button>
  </div>

  <div id="agendaDiv">
    <h2>Agenda do Fofo</h2>
    <input type="date" id="data"><br><br>
    <div id="compromissos"></div>
    <div id="saveIcon">üíæ</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // Configura√ß√£o Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBiikcagIm1p7wJG6DsHijkvdy1fpDBn8Y",
      authDomain: "bd-teste-c931c.firebaseapp.com",
      databaseURL: "https://bd-teste-c931c-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "bd-teste-c931c",
      storageBucket: "bd-teste-c931c.firebasestorage.app",
      messagingSenderId: "270308100761",
      appId: "1:270308100761:web:ae34fde6d5ae86b67b0608"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    // Login
    window.login = function() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      signInWithEmailAndPassword(auth, email, password)
        .catch(err => alert("Erro: " + err.message));
    };

    onAuthStateChanged(auth, user => {
      if (user) {
        document.getElementById("loginDiv").style.display = "none";
        document.getElementById("agendaDiv").style.display = "block";
        carregarCompromissos();
      }
    });

    // Compromissos
    const compromissosDiv = document.getElementById("compromissos");
    const total = 15;
    for (let i = 0; i < total; i++) {
      const div = document.createElement("div");
      div.className = "compromisso";
      div.innerHTML = `
        <input type="time" class="hora">
        <input type="text" class="texto" placeholder="Compromisso ${i+1}">
      `;
      compromissosDiv.appendChild(div);
    }

    const dataInput = document.getElementById("data");
    dataInput.valueAsDate = new Date();

    function salvarCompromissos() {
      const user = auth.currentUser;
      if (!user) return;
      const date = dataInput.value;
      const dados = [];
      document.querySelectorAll(".compromisso").forEach(div => {
        const hora = div.querySelector(".hora").value;
        const texto = div.querySelector(".texto").value;
        dados.push({ hora, texto, avisadoEm: "" });
      });
      set(ref(db, "agenda/" + user.uid + "/" + date), dados);

      const icon = document.getElementById("saveIcon");
      icon.style.display = "block";
      setTimeout(() => icon.style.display = "none", 1000);
    }

    async function carregarCompromissos() {
      const user = auth.currentUser;
      if (!user) return;
      const date = dataInput.value;
      const snap = await get(child(ref(db), "agenda/" + user.uid + "/" + date));
      if (snap.exists()) {
        snap.val().forEach((c, i) => {
          document.querySelectorAll(".hora")[i].value = c.hora || "";
          document.querySelectorAll(".texto")[i].value = c.texto || "";
        });
      }
    }

    // Auto salvar
    setInterval(salvarCompromissos, 5000);
    dataInput.addEventListener("change", carregarCompromissos);

    // Permiss√£o de Notifica√ß√£o
    if ("Notification" in window && Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    // Alarme
    setInterval(async () => {
      const user = auth.currentUser;
      if (!user) return;
      const date = new Date().toISOString().slice(0,10);
      const snap = await get(child(ref(db), "agenda/" + user.uid + "/" + date));
      if (!snap.exists()) return;
      const compromissos = snap.val();
      const agora = new Date();
      const horaAtual = agora.toTimeString().slice(0,5); // hh:mm

      compromissos.forEach(c => {
        if (c.hora === horaAtual && (!c.avisadoEm || c.avisadoEm !== date)) {
          // alert vis√≠vel sempre
          alert("‚è∞ Compromisso agora: " + c.texto);

          // notifica√ß√£o do sistema
          if ("Notification" in window && Notification.permission === "granted") {
            new Notification("‚è∞ Compromisso agora!", { body: c.texto });
          }

          c.avisadoEm = date;
          set(ref(db, "agenda/" + user.uid + "/" + date), compromissos);
        }
      });
    }, 30000); // verifica a cada 30s
  </script>
</body>
</html>
