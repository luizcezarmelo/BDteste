<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda da Val</title>
  <style>
    /* CSS para a tela de login */
    #login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #f0f2f5;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #login-form {
      background-color: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    #login-form h2 {
      margin-top: 0;
    }
    #login-form input {
      padding: 10px;
      margin: 10px 0;
      width: 250px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #password-container {
      position: relative;
    }
    #password-container button {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
    }
    #login-button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      width: 100%;
    }
    #login-button:hover {
      background-color: #0056b3;
    }
    #error-message {
      color: red;
      margin-top: 10px;
      font-size: 0.9rem;
      display: none;
    }
    /* Seu CSS original */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #fff;
      color: #000;
    }
    .container {
      display: flex;
      flex-direction: column;
    }
    @media (min-width: 768px) {
      .container {
        flex-direction: row;
        min-height: 100vh;
      }
    }
    .left-panel, .right-panel { padding: 20px; }
    .left-panel { flex: 2; border-right: 1px solid #ccc; }
    .right-panel { flex: 1; }
    .calendar-section {
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .calendar-section button {
      padding: 5px 10px;
      font-size: 14px;
      cursor: pointer;
    }
    .day-nav {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: -10px 0 10px 0;
    }
    .day-nav button {
      padding: 2px 8px;
      font-size: 16px;
      cursor: pointer;
    }
    .actions { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    .search-area {
      display: flex; gap: 5px; margin-bottom: 10px; align-items: center; flex-wrap: wrap;
    }
    .search-area input { flex: 1; padding: 5px; min-width: 120px; }
    .search-results {
      background-color: #fff; border: 1px solid transparent; padding: 10px; max-height: 150px; overflow-y: auto;
    }
    .search-results div {
      cursor: pointer; padding: 4px;
    }
    .search-results div:hover {
      background-color: #eee;
    }
    .destaque {
      background: yellow;
    }
    .commitment {
      display: flex;
      align-items: center;
      gap: 5px; /* Adicionado gap para espa√ßamento */
      margin-bottom: 5px;
      flex-wrap: wrap;
      padding: 5px;
    }
    .commitment input[type="text"] {
      flex: 1;
      padding: 5px;
      min-width: 120px;
    }
    .commitment input[type="time"] {
      padding: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .lembrete-label {
      cursor: pointer;
      font-size: 1.2rem;
    }
    .commitment button { margin-left: 3px; }
    .done { text-decoration: line-through; color: gray; }
    #cpfStatus.valid { color: blue; }
    #cpfStatus.invalid { color: red; }
    .commitment.checked {
      background-color: #d1e7ff;
    }
    .commitment:nth-child(even) {
      background-color: #f2f2f2;
    }
    .commitment:nth-child(even).checked {
      background-color: #aed6f1;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
  <div id="login-screen">
    <div id="login-form">
      <h2 id="login-title">Acesso Restrito</h2>
      <div id="password-container">
        <input type="password" id="password-input" placeholder="Digite a senha" onkeypress="handleKeyPress(event)">
        <button id="toggle-password" onclick="togglePasswordVisibility()">üëÅÔ∏è</button>
      </div>
      <p id="error-message">Senha incorreta. Tente novamente.</p>
      <button id="login-button" onclick="checkPassword()">Entrar</button>
      <div id="setup-message" style="display: none; margin-top: 15px;">
        <p>Ainda n√£o h√° senha. Defina uma para continuar.</p>
        <button id="set-password-button" onclick="setPassword()">Definir Senha</button>
      </div>
    </div>
  </div>

  <div class="container" id="main-content" style="display: none;">
    <div class="left-panel">
      <h1>Agenda da Val</h1>
      <div class="calendar-section">
        <input type="date" id="dataSelecionada">
        <button id="hojeBtn" title="Hoje">üìÖ</button>
      </div>
      <div class="day-nav">
        <button id="prevDayBtn" title="Dia anterior">‚óÄ</button>
        <button id="nextDayBtn" title="Pr√≥ximo dia">‚ñ∂</button>
      </div>
      <div class="actions">
        <button id="novoBtn">Novo</button>
        <button id="copiarBtn">Copiar</button>
        <button id="colarBtn">Colar</button>
        <button id="exportarBtn">Exportar TXT</button>
      </div>
      <div id="agenda"></div>
    </div>
    <div class="right-panel">
      <div id="cpf-validator-section" style="display: none;">
        <h2>Validador de CPF</h2>
        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
          <input type="text" id="cpf" placeholder="Digite o CPF">
          <button onclick="limparCPF()" title="Limpar CPF">‚ùå</button>
        </div>
        <p id="cpfStatus"></p>
        <button onclick="copiarCPF()">Copiar</button>
      </div>
      <h3>üîç Pesquisa</h3>
      <div class="search-area">
        <input type="text" id="search" placeholder="Pesquisar...">
        <button onclick="limparBusca()">‚ùå</button>
      </div>
      <div id="searchResults" class="search-results"></div>
      <h3>üìù Lembretes:</h3>
      <textarea id="notasFixas" rows="15" style="width: 100%; resize: vertical;"></textarea>
    </div>
  </div>

<script>
    // --- L√ìGICA DE LOGIN ---
    const PASSWORD_NODE = 'appPassword';
    const mainContent = document.getElementById('main-content');
    const loginScreen = document.getElementById('login-screen');
    const passwordInput = document.getElementById('password-input');
    const errorMessage = document.getElementById('error-message');
    const togglePasswordBtn = document.getElementById('toggle-password');
    const setupMessage = document.getElementById('setup-message');
    const loginTitle = document.getElementById('login-title');

    // ** CONFIGURA√á√ÉO DO FIREBASE **
    const firebaseConfig = {
      apiKey: "AIzaSyCeygrkw2tQHHYy5ocBcMBnRyYvAVXRW2g",
      authDomain: "agenda-da-val.firebaseapp.com",
      databaseURL: "https://agenda-da-val-default-rtdb.firebaseio.com",
      projectId: "agenda-da-val",
      storageBucket: "agenda-da-val.appspot.com",
      messagingSenderId: "4483197465",
      appId: "1:4483197465:web:a31a604e5ab0a3e7021888"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let correctPassword = null;

    async function loadPassword() {
        const snapshot = await database.ref(PASSWORD_NODE).once('value');
        correctPassword = snapshot.val();
        if (correctPassword) {
            setupMessage.style.display = 'none';
            loginTitle.textContent = 'Acesso Restrito';
        } else {
            setupMessage.style.display = 'block';
            loginTitle.textContent = 'Configurar Senha';
            document.getElementById('login-button').style.display = 'none';
            passwordInput.placeholder = 'Defina uma senha';
        }
        loginScreen.style.display = 'flex';
    }

    function setPassword() {
        const newPassword = passwordInput.value;
        if (newPassword && newPassword.trim() !== '') {
            database.ref(PASSWORD_NODE).set(newPassword).then(() => {
                alert('Senha definida com sucesso!');
                loadPassword();
                passwordInput.value = '';
                document.getElementById('login-button').style.display = 'block';
                passwordInput.placeholder = 'Digite a senha';
            }).catch(error => console.error("Erro ao salvar a senha:", error));
        } else {
            alert('A senha n√£o pode ser vazia.');
        }
    }

    function checkPassword() {
        if (passwordInput.value === correctPassword) {
            showMainContent();
        } else {
            errorMessage.style.display = 'block';
            passwordInput.value = '';
        }
    }

    function showMainContent() {
      loginScreen.style.display = 'none';
      mainContent.style.display = 'flex';
      carregarAgenda();
      carregarNotasFixas();
      // Inicia o verificador de lembretes
      setInterval(verificarLembretes, 30000); // Verifica a cada 30 segundos
    }

    function togglePasswordVisibility() {
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        togglePasswordBtn.textContent = 'üôà';
      } else {
        passwordInput.type = 'password';
        togglePasswordBtn.textContent = 'üëÅÔ∏è';
      }
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            correctPassword ? checkPassword() : setPassword();
        }
    }

    window.addEventListener('load', loadPassword);
    // --- FIM L√ìGICA DE LOGIN ---

    const agendaEl = document.getElementById('agenda');
    const searchEl = document.getElementById('search');
    const searchResultsEl = document.getElementById('searchResults');
    const dataInput = document.getElementById('dataSelecionada');
    const novoBtn = document.getElementById('novoBtn');
    const copiarBtn = document.getElementById('copiarBtn');
    const colarBtn = document.getElementById('colarBtn');
    const exportarBtn = document.getElementById('exportarBtn');
    const hojeBtn = document.getElementById('hojeBtn');
    const prevDayBtn = document.getElementById('prevDayBtn');
    const nextDayBtn = document.getElementById('nextDayBtn');
    const notasFixasEl = document.getElementById('notasFixas');

    const maxCompromissos = 20;
    let bufferCopiados = [];

    dataInput.value = new Date().toISOString().split('T')[0];

    dataInput.addEventListener('change', carregarAgenda);
    novoBtn.addEventListener('click', adicionarCompromisso);
    copiarBtn.addEventListener('click', copiarCompromissos);
    colarBtn.addEventListener('click', colarCompromissos);
    exportarBtn.addEventListener('click', () => exportarParaTXT(dataInput.value));
    hojeBtn.addEventListener('click', () => {
      dataInput.value = new Date().toISOString().split('T')[0];
      carregarAgenda();
    });
    prevDayBtn.addEventListener('click', () => {
      const d = new Date(dataInput.value);
      d.setDate(d.getDate() - 1);
      dataInput.value = d.toISOString().split('T')[0];
      carregarAgenda();
    });
    nextDayBtn.addEventListener('click', () => {
      const d = new Date(dataInput.value);
      d.setDate(d.getDate() + 1);
      dataInput.value = d.toISOString().split('T')[0];
      carregarAgenda();
    });
    searchEl.addEventListener('input', pesquisarCompromisso);

    let debounceTimer;
    function salvarComDelay() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(salvarAgenda, 1000);
    }

    async function carregarAgenda() {
      const data = dataInput.value;
      agendaEl.innerHTML = '';
      const section = document.createElement('div');
      section.className = 'date-section';
      section.dataset.data = data;
      const compromissos = document.createElement('div');
      compromissos.className = 'commitments';

      const snapshot = await database.ref('agenda/' + data).once('value');
      let dadosSalvos = snapshot.val() || [];
      while (dadosSalvos.length < 15) dadosSalvos.push({ texto: '', hora: '', tachado: false, selecionado: false, lembreteAtivo: false });

      dadosSalvos.forEach(item => compromissos.appendChild(criarCampoCompromisso(item)));
      section.appendChild(compromissos);
      agendaEl.appendChild(section);
    }

    function salvarAgenda() {
      const data = dataInput.value;
      const section = document.querySelector('.date-section');
      if (!section) return;

      const textos = [];
      section.querySelectorAll('.commitment').forEach(div => {
        const input = div.querySelector('input[type=text]');
        const checkbox = div.querySelector('input[type=checkbox]');
        const horaInput = div.querySelector('input[type=time]');
        const lembreteCheckbox = div.querySelector('.lembrete-checkbox');

        textos.push({
          texto: input.value,
          tachado: input.classList.contains('done'),
          selecionado: checkbox.checked,
          hora: horaInput.value,
          lembreteAtivo: lembreteCheckbox.checked
        });
      });
      database.ref('agenda/' + data).set(textos);
    }

    function criarCampoCompromisso(item = {}) {
      const div = document.createElement('div');
      div.className = 'commitment';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = item.selecionado || false;
      checkbox.addEventListener('change', () => {
        div.classList.toggle('checked', checkbox.checked);
        salvarAgenda();
      });
      if (item.selecionado) div.classList.add('checked');

      const input = document.createElement('input');
      input.type = 'text';
      input.value = item.texto || '';
      if (item.tachado) input.classList.add('done');
      input.addEventListener('input', salvarComDelay);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const allInputs = [...document.querySelectorAll('.commitment input[type=text]')];
          const idx = allInputs.indexOf(input);
          if (allInputs[idx + 1]) allInputs[idx + 1].focus();
        }
      });
      
      // NOVO: Campo de Hora
      const horaInput = document.createElement('input');
      horaInput.type = 'time';
      horaInput.value = item.hora || '';
      horaInput.addEventListener('change', salvarAgenda);

      // NOVO: Checkbox para Lembrete (sino)
      const lembreteCheckbox = document.createElement('input');
      lembreteCheckbox.type = 'checkbox';
      lembreteCheckbox.checked = item.lembreteAtivo || false;
      lembreteCheckbox.className = 'lembrete-checkbox';
      lembreteCheckbox.style.display = 'none'; // Oculta o checkbox real
      lembreteCheckbox.id = 'lembrete-' + Math.random(); // ID √∫nico para o label
      lembreteCheckbox.addEventListener('change', salvarAgenda);

      const lembreteLabel = document.createElement('label');
      lembreteLabel.className = 'lembrete-label';
      lembreteLabel.textContent = 'üîî';
      lembreteLabel.title = 'Ativar/Desativar lembrete';
      lembreteLabel.setAttribute('for', lembreteCheckbox.id);

      const okBtn = document.createElement('button');
      okBtn.textContent = 'OK';
      okBtn.onclick = () => {
        input.classList.toggle('done');
        salvarAgenda();
      };

      const delBtn = document.createElement('button');
      delBtn.textContent = 'Excluir';
      delBtn.onclick = () => {
        input.value = '';
        horaInput.value = '';
        lembreteCheckbox.checked = false;
        input.classList.remove('done');
        salvarAgenda();
      };

      div.appendChild(checkbox);
      div.appendChild(input);
      div.appendChild(horaInput); // Adicionado √† tela
      div.appendChild(lembreteCheckbox); // Adicionado (oculto)
      div.appendChild(lembreteLabel); // Adicionado (vis√≠vel)
      div.appendChild(okBtn);
      div.appendChild(delBtn);
      return div;
    }

    function adicionarCompromisso() {
      const compromissos = document.querySelector('.commitments');
      if (compromissos.children.length < maxCompromissos) {
        compromissos.appendChild(criarCampoCompromisso());
      }
    }

    // --- NOVA FUN√á√ÉO PARA VERIFICAR E DISPARAR LEMBRETES ---
    function verificarLembretes() {
      const hoje = new Date().toISOString().split('T')[0];
      // S√≥ executa se a data selecionada na agenda for a data de hoje
      if (dataInput.value !== hoje) {
        return;
      }

      const agora = new Date();
      // Formata a hora atual para HH:MM
      const horaAtual = agora.getHours().toString().padStart(2, '0') + ':' + agora.getMinutes().toString().padStart(2, '0');

      const compromissos = document.querySelectorAll('.commitment');
      compromissos.forEach(div => {
        const inputTexto = div.querySelector('input[type="text"]');
        const inputHora = div.querySelector('input[type="time"]');
        const checkLembrete = div.querySelector('.lembrete-checkbox');

        // Verifica se o lembrete est√° ativo, se a hora bate e se tem texto no compromisso
        if (checkLembrete.checked && inputHora.value === horaAtual && inputTexto.value.trim() !== '') {
          // Exibe o alerta
          alert(`LEMBRETE: ${inputTexto.value}`);
          
          // Desativa o lembrete para n√£o alertar novamente e salva
          checkLembrete.checked = false;
          salvarAgenda();
        }
      });
    }


    async function pesquisarCompromisso() {
        const termo = searchEl.value.trim().toLowerCase();
        searchResultsEl.innerHTML = '';
        if (termo.length < 3) return;
        const snapshot = await database.ref('agenda').once('value');
        const todasAsAgendas = snapshot.val();
        if (!todasAsAgendas) return;
        
        const resultados = [];
        for (const data in todasAsAgendas) {
            todasAsAgendas[data].forEach((item, index) => {
                if (item.texto && item.texto.toLowerCase().includes(termo)) {
                    resultados.push({ data, index, item });
                }
            });
        }

        if (resultados.length > 0) {
            resultados.forEach(({ data, index, item }) => {
            const divResultado = document.createElement('div');
            divResultado.textContent = `Dia: ${data} - ${item.texto}`;
            divResultado.onclick = () => {
                dataInput.value = data;
                carregarAgenda().then(() => {
                    const compromisso = agendaEl.querySelectorAll('.commitment')[index];
                    if (compromisso) {
                        compromisso.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        compromisso.classList.add('destaque');
                        setTimeout(() => compromisso.classList.remove('destaque'), 2000);
                    }
                });
            };
            searchResultsEl.appendChild(divResultado);
            });
        } else {
            searchResultsEl.textContent = 'Nenhum compromisso encontrado.';
        }
    }

    function limparBusca() {
      searchEl.value = '';
      searchResultsEl.innerHTML = '';
    }

    async function exportarParaTXT(data) {
        const snapshot = await database.ref('agenda/' + data).once('value');
        const dados = snapshot.val() || [];
        let conteudo = `Agenda de ${data}\n\n`;
        dados.forEach((item, i) => {
            if (item.texto) {
            let linha = `${i + 1}. `;
            if(item.hora) linha += `[${item.hora}] `;
            linha += `${item.texto}${item.tachado ? ' (Conclu√≠do)' : ''}\n`;
            conteudo += linha;
            }
        });
        const blob = new Blob([conteudo], { type: 'text/plain;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `agenda_${data}.txt`;
        a.click();
    }

    function copiarCompromissos() {
      bufferCopiados = [];
      const section = document.querySelector('.date-section');
      if (!section) return;
      section.querySelectorAll('.commitment').forEach(div => {
        const input = div.querySelector('input[type="text"]');
        if (!input.classList.contains('done')) {
          bufferCopiados.push(input.value);
          input.classList.add('done');
        }
      });
      salvarAgenda();
    }

    function colarCompromissos() {
      if (!bufferCopiados.length) return;
      const compromissosDiv = document.querySelector('.commitments');
      if (!compromissosDiv) return;
      let idxBuffer = 0;
      function encontrarOuAdicionarCampoVazio() {
        let vazio = [...compromissosDiv.children].find(div => !div.querySelector('input[type=text]').value);
        if (vazio) return vazio;
        if (compromissosDiv.children.length < maxCompromissos) {
          const novo = criarCampoCompromisso();
          compromissosDiv.appendChild(novo);
          return novo;
        }
        return null;
      }
      while (idxBuffer < bufferCopiados.length) {
        const campo = encontrarOuAdicionarCampoVazio();
        if (!campo) break;
        campo.querySelector('input[type=text]').value = bufferCopiados[idxBuffer++];
        campo.querySelector('input[type=text]').classList.remove('done');
        campo.querySelector('input[type="checkbox"]').checked = false;
        campo.classList.remove('checked');
      }
      salvarAgenda();
    }

    function validarCPF(cpf) {
      if (!cpf || cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
      let soma = 0, resto;
      for (let i = 1; i <= 9; i++) soma += parseInt(cpf[i - 1]) * (11 - i);
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf[9])) return false;
      soma = 0;
      for (let i = 1; i <= 10; i++) soma += parseInt(cpf[i - 1]) * (12 - i);
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      return resto === parseInt(cpf[10]);
    }
    document.getElementById('cpf').addEventListener('input', () => {
      const raw = document.getElementById('cpf').value.replace(/\D/g, '');
      const status = document.getElementById('cpfStatus');
      const valido = validarCPF(raw);
      status.textContent = valido ? 'CPF v√°lido' : 'CPF inv√°lido';
      status.className = valido ? 'valid' : 'invalid';
    });
    function copiarCPF() {
      let raw = document.getElementById('cpf').value.replace(/\D/g, '');
      if (validarCPF(raw)) {
        let formatado = raw.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
        navigator.clipboard.writeText(formatado);
      }
    }
    function limparCPF() {
      document.getElementById('cpf').value = '';
      document.getElementById('cpfStatus').textContent = '';
      document.getElementById('cpfStatus').className = '';
    }

    async function carregarNotasFixas() {
        const snapshot = await database.ref('notasFixas').once('value');
        notasFixasEl.value = snapshot.val() || '';
    }
    notasFixasEl.addEventListener('input', () => {
        database.ref('notasFixas').set(notasFixasEl.value);
    });

    document.addEventListener('input', (e) => {
      if (e.target.matches('input[type="text"], textarea')) {
        const pos = e.target.selectionStart;
        e.target.value = e.target.value.toUpperCase();
        e.target.setSelectionRange(pos, pos);
      }
    });
</script>
</body>
</html>