<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda da Val</title>
  <style>
    /* --- SEU CSS ORIGINAL --- */
    #login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #f0f2f5;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #login-form {
      background-color: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    #login-form h2 { margin-top: 0; }
    #login-form input { padding: 10px; margin: 10px 0; width: 250px; border: 1px solid #ccc; border-radius: 4px; }
    #password-container { position: relative; }
    #password-container button { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.2rem; }
    #login-button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      width: 100%;
    }
    #login-button:hover { background-color: #0056b3; }
    #error-message { color: red; margin-top: 10px; font-size: 0.9rem; display: none; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, sans-serif; background-color: #fff; color: #000; }
    .container { display: flex; flex-direction: column; }
    @media (min-width: 768px) { .container { flex-direction: row; min-height: 100vh; } }
    .left-panel, .right-panel { padding: 20px; }
    .left-panel { flex: 2; border-right: 1px solid #ccc; }
    .right-panel { flex: 1; }
    .calendar-section { margin: 20px 0; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .calendar-section button { padding: 5px 10px; font-size: 14px; cursor: pointer; }
    .day-nav { display: flex; gap: 8px; align-items: center; margin: -10px 0 10px 0; }
    .day-nav button { padding: 2px 8px; font-size: 16px; cursor: pointer; }
    .actions { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    .search-area { display: flex; gap: 5px; margin-bottom: 10px; align-items: center; flex-wrap: wrap; }
    .search-area input { flex: 1; padding: 5px; min-width: 120px; }
    .search-results { background-color: #fff; border: 1px solid transparent; padding: 10px; max-height: 150px; overflow-y: auto; }
    .search-results div { cursor: pointer; padding: 4px; }
    .search-results div:hover { background-color: #eee; }
    .destaque { background: yellow; }
    .commitment { display: flex; align-items: center; margin-bottom: 5px; flex-wrap: wrap; padding: 5px; }
    .commitment input[type="text"] { flex: 1; padding: 5px; margin-right: 5px; min-width: 120px; }
    .commitment button { margin-left: 3px; }
    .done { text-decoration: line-through; color: gray; }
    #cpfStatus.valid { color: blue; }
    #cpfStatus.invalid { color: red; }
    .commitment.checked { background-color: #d1e7ff; }
    .commitment:nth-child(even) { background-color: #f2f2f2; }
    .commitment:nth-child(even).checked { background-color: #aed6f1; }
    input[type="time"] { margin-right:5px; }
    .alarm-btn { margin-right:5px; cursor:pointer; }
    .alarm-on { color:red; font-weight:bold; }
  </style>
  <!-- Firebase 9.x compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
  <div id="login-screen">
    <div id="login-form">
      <h2 id="login-title">Acesso Restrito</h2>
      <div id="password-container">
        <input type="password" id="password-input" placeholder="Digite a senha" onkeypress="handleKeyPress(event)">
        <button id="toggle-password" onclick="togglePasswordVisibility()">üëÅÔ∏è</button>
      </div>
      <p id="error-message">Senha incorreta. Tente novamente.</p>
      <button id="login-button" onclick="checkPassword()">Entrar</button>
      <div id="setup-message" style="display: none; margin-top: 15px;">
        <p>Ainda n√£o h√° senha. Defina uma para continuar.</p>
        <button id="set-password-button" onclick="setPassword()">Definir Senha</button>
      </div>
    </div>
  </div>

  <div class="container" id="main-content" style="display: none;">
    <div class="left-panel">
      <h1>Agenda da Val</h1>
      <div class="calendar-section">
        <input type="date" id="dataSelecionada">
        <button id="hojeBtn" title="Hoje">üìÖ</button>
      </div>
      <div class="day-nav">
        <button id="prevDayBtn" title="Dia anterior">‚óÄ</button>
        <button id="nextDayBtn" title="Pr√≥ximo dia">‚ñ∂</button>
      </div>
      <div class="actions">
        <button id="novoBtn">Novo</button>
        <button id="copiarBtn">Copiar</button>
        <button id="colarBtn">Colar</button>
        <button id="exportarBtn">Exportar TXT</button>
      </div>
      <div id="agenda"></div>
    </div>
    <div class="right-panel">
      <div id="cpf-validator-section" style="display: none;">
        <h2>Validador de CPF</h2>
        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
          <input type="text" id="cpf" placeholder="Digite o CPF">
          <button onclick="limparCPF()" title="Limpar CPF">‚ùå</button>
        </div>
        <p id="cpfStatus"></p>
        <button onclick="copiarCPF()">Copiar</button>
      </div>
      <h3>üîç Pesquisa</h3>
      <div class="search-area">
        <input type="text" id="search" placeholder="Pesquisar...">
        <button onclick="limparBusca()">‚ùå</button>
      </div>
      <div id="searchResults" class="search-results"></div>
      <h3>üìù Lembretes:</h3>
      <textarea id="notasFixas" rows="15" style="width: 100%; resize: vertical;"></textarea>
    </div>
  </div>

<script>
  // --- CONFIGURA√á√ÉO FIREBASE ---
  const firebaseConfig = {
    apiKey: "AIzaSyBiikcagIm1p7wJG6DsHijkvdy1fpDBn8Y",
    authDomain: "bd-teste-c931c.firebaseapp.com",
    databaseURL: "https://bd-teste-c931c-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "bd-teste-c931c",
    storageBucket: "bd-teste-c931c.appspot.com",
    messagingSenderId: "270308100761",
    appId: "1:270308100761:web:ae34fde6d5ae86b67b0608"
  };
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  const PASSWORD_NODE = 'appPassword';
  const mainContent = document.getElementById('main-content');
  const loginScreen = document.getElementById('login-screen');
  const passwordInput = document.getElementById('password-input');
  const errorMessage = document.getElementById('error-message');
  const togglePasswordBtn = document.getElementById('toggle-password');
  const setupMessage = document.getElementById('setup-message');
  const loginTitle = document.getElementById('login-title');

  let correctPassword = null;

  // --- FUN√á√ÉO CARREGAR SENHA FIREBASE ---
  async function loadPassword() {
    const snapshot = await database.ref(PASSWORD_NODE).once('value');
    correctPassword = snapshot.val();
    if (correctPassword) {
      setupMessage.style.display = 'none';
      loginTitle.textContent = 'Acesso Restrito';
      document.getElementById('login-button').style.display = 'block';
    } else {
      setupMessage.style.display = 'block';
      loginTitle.textContent = 'Configurar Senha';
      document.getElementById('login-button').style.display = 'none';
      passwordInput.placeholder = 'Defina uma senha';
    }
    loginScreen.style.display = 'flex';
  }

  // --- FUN√á√ÉO DEFINIR SENHA ---
  function setPassword() {
    const newPassword = passwordInput.value.trim();
    if (!newPassword) return alert('A senha n√£o pode ser vazia.');
    database.ref(PASSWORD_NODE).set(newPassword).then(() => {
      alert('Senha definida com sucesso!');
      passwordInput.value = '';
      loadPassword();
    });
  }

  // --- FUN√á√ÉO CHECAR SENHA ---
  function checkPassword() {
    if (passwordInput.value === correctPassword) {
      showMainContent();
    } else {
      errorMessage.style.display = 'block';
      passwordInput.value = '';
    }
  }

  // --- FUN√á√ÉO MOSTRAR CONTE√öDO ---
  function showMainContent() {
    loginScreen.style.display = 'none';
    mainContent.style.display = 'flex';
    carregarAgenda();
    carregarNotasFixas();
  }

  // --- TOGGLE SENHA ---
  function togglePasswordVisibility() {
    if (passwordInput.type==='password') {
      passwordInput.type='text'; togglePasswordBtn.textContent='üôà';
    } else {
      passwordInput.type='password'; togglePasswordBtn.textContent='üëÅÔ∏è';
    }
  }

  // --- LOGIN COM ENTER ---
  function handleKeyPress(e) {
    if(e.key==='Enter'){
      correctPassword ? checkPassword() : setPassword();
    }
  }

  window.addEventListener('load', loadPassword);

  // --- VARI√ÅVEIS AGENDA ---
  const agendaEl = document.getElementById('agenda');
  const searchEl = document.getElementById('search');
  const searchResultsEl = document.getElementById('searchResults');
  const dataInput = document.getElementById('dataSelecionada');
  const novoBtn = document.getElementById('novoBtn');
  const copiarBtn = document.getElementById('copiarBtn');
  const colarBtn = document.getElementById('colarBtn');
  const exportarBtn = document.getElementById('exportarBtn');
  const hojeBtn = document.getElementById('hojeBtn');
  const prevDayBtn = document.getElementById('prevDayBtn');
  const nextDayBtn = document.getElementById('nextDayBtn');
  const notasFixasEl = document.getElementById('notasFixas');

  const maxCompromissos = 20;
  let bufferCopiados = [];

  dataInput.value = new Date().toISOString().split('T')[0];

  novoBtn.addEventListener('click', adicionarCompromisso);
  copiarBtn.addEventListener('click', copiarCompromissos);
  colarBtn.addEventListener('click', colarCompromissos);
  exportarBtn.addEventListener('click', () => exportarParaTXT(dataInput.value));
  hojeBtn.addEventListener('click',()=>{dataInput.value=new Date().toISOString().split('T')[0]; carregarAgenda();});
  prevDayBtn.addEventListener('click',()=>{const d=new Date(dataInput.value);d.setDate(d.getDate()-1);dataInput.value=d.toISOString().split('T')[0];carregarAgenda();});
  nextDayBtn.addEventListener('click',()=>{const d=new Date(dataInput.value);d.setDate(d.getDate()+1);dataInput.value=d.toISOString().split('T')[0];carregarAgenda();});
  dataInput.addEventListener('change', carregarAgenda);
  searchEl.addEventListener('input', pesquisarCompromisso);

  let debounceTimer;
  function salvarComDelay(){clearTimeout(debounceTimer);debounceTimer=setTimeout(()=>salvarAgenda(),1000);}

  // --- FUN√á√ÉO CRIAR CAMPO DE COMPROMISSO ---
  function criarCampoCompromisso(item={texto:'',hora:'',tachado:false,selecionado:false}){
    const div=document.createElement('div'); div.className='commitment';
    const checkbox=document.createElement('input'); checkbox.type='checkbox'; checkbox.checked=item.selecionado;
    checkbox.addEventListener('change',()=>{div.classList.toggle('checked',checkbox.checked); salvarAgenda();});
    if(item.selecionado) div.classList.add('checked');
    const horaInput=document.createElement('input'); horaInput.type='time'; horaInput.value=item.hora || '';
    horaInput.addEventListener('change', salvarComDelay);
    const alarmBtn=document.createElement('button'); alarmBtn.textContent='üîî'; alarmBtn.className='alarm-btn';
    if(item.alarm) alarmBtn.classList.add('alarm-on');
    alarmBtn.onclick=()=>alarmBtn.classList.toggle('alarm-on');
    const textoInput=document.createElement('input'); textoInput.type='text'; textoInput.value=item.texto;
    if(item.tachado) textoInput.classList.add('done');
    textoInput.addEventListener('input',salvarComDelay);
    textoInput.addEventListener('keydown',e=>{if(e.key==='Enter'){const all=[...document.querySelectorAll('.commitment input[type=text]')]; const idx=all.indexOf(textoInput); const next=all[idx+1]; if(next) next.focus();}});
    const okBtn=document.createElement('button'); okBtn.textContent='OK'; okBtn.onclick=()=>{textoInput.classList.toggle('done'); salvarAgenda();};
    const delBtn=document.createElement('button'); delBtn.textContent='X'; delBtn.onclick=()=>{div.remove(); salvarAgenda();};
    div.appendChild(checkbox); div.appendChild(horaInput); div.appendChild(alarmBtn); div.appendChild(textoInput); div.appendChild(okBtn); div.appendChild(delBtn);
    return div;
  }

  function adicionarCompromisso(){
    const compromissos=document.querySelector('.commitments');
    if(!compromissos){
      const section=document.createElement('div'); section.className='date-section';
      const inner=document.createElement('div'); inner.className='commitments';
      section.appendChild(inner); agendaEl.appendChild(section);
    }
    const divComp=document.querySelector('.commitments');
    if(divComp.children.length<maxCompromissos) divComp.appendChild(criarCampoCompromisso());
  }

  async function carregarAgenda(){
    const data=dataInput.value;
    agendaEl.innerHTML='';
    const section=document.createElement('div'); section.className='date-section'; section.dataset.data=data;
    const compromissos=document.createElement('div'); compromissos.className='commitments';
    const snapshot=await database.ref('agenda/'+data).once('value'); let dadosSalvos=snapshot.val()||[];
    while(dadosSalvos.length<15) dadosSalvos.push({texto:'',hora:'',tachado:false,selecionado:false,alarm:false});
    dadosSalvos.forEach(item=>compromissos.appendChild(criarCampoCompromisso(item)));
    section.appendChild(compromissos); agendaEl.appendChild(section);
  }

  function salvarAgenda(){
    const data=dataInput.value;
    const section=document.querySelector('.date-section'); if(!section) return;
    const textos=[];
    section.querySelectorAll('.commitment').forEach(div=>{
      const input=div.querySelector('input[type=text]');
      const hora=div.querySelector('input[type=time]').value;
      const alarm=div.querySelector('.alarm-btn').classList.contains('alarm-on');
      const checkbox=div.querySelector('input[type=checkbox]');
      textos.push({texto:input.value,hora:hora,tachado:input.classList.contains('done'),selecionado:checkbox.checked,alarm:alarm});
    });
    database.ref('agenda/'+data).set(textos);
  }

  // --- ALARME ---
  setInterval(()=>{
    const now=new Date(); const horas=now.getHours().toString().padStart(2,'0'); const minutos=now.getMinutes().toString().padStart(2,'0');
    document.querySelectorAll('.commitment').forEach(div=>{
      const horaInput=div.querySelector('input[type=time]');
      const alarmBtn=div.querySelector('.alarm-btn');
      const textoInput=div.querySelector('input[type=text]');
      if(alarmBtn.classList.contains('alarm-on') && horaInput.value===horas+':'+minutos && textoInput.value!==''){
        if(Notification.permission==='granted'){new Notification('Lembrete', {body:textoInput.value});}
      }
    });
  },60000);
  if(Notification.permission!=='granted'){Notification.requestPermission();}

  // --- EXPORTAR ---
  function exportarParaTXT(data){
    const snapshot=document.querySelectorAll('.commitment input[type=text]');
    let conteudo='Compromissos de '+data+'\n';
    snapshot.forEach(inp=>{conteudo+=inp.value+'\n';});
    const blob=new Blob([conteudo],{type:'text/plain'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='agenda-'+data+'.txt'; a.click();
  }

  // --- COPIAR / COLAR ---
  function copiarCompromissos(){bufferCopiados=[]; document.querySelectorAll('.commitment input[type=text]').forEach(inp=>bufferCopiados.push(inp.value)); alert('Compromissos copiados!');}
  function colarCompromissos(){if(bufferCopiados.length===0) return; document.querySelectorAll('.commitment input[type=text]').forEach((inp,i)=>{inp.value=bufferCopiados[i]||''}); salvarAgenda();}

  // --- PESQUISA ---
  function pesquisarCompromisso(){
    const termo=searchEl.value.toLowerCase(); searchResultsEl.innerHTML='';
    if(!termo) return;
    document.querySelectorAll('.commitment').forEach(div=>{
      const texto=div.querySelector('input[type=text]').value;
      if(texto.toLowerCase().includes(termo)){
        const res=document.createElement('div'); res.textContent=texto; searchResultsEl.appendChild(res);
      }
    });
  }

  function limparBusca(){searchEl.value=''; searchResultsEl.innerHTML='';}

  // --- NOTAS FIXAS ---
  async function carregarNotasFixas(){
    const snapshot=await database.ref('notasFixas').once('value'); notasFixasEl.value=snapshot.val()||'';
  }
  notasFixasEl.addEventListener('input',()=>{database.ref('notasFixas').set(notasFixasEl.value);});
</script>
</body>
</html>
