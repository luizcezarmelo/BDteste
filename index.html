<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda da Val</title>
  <style>
    /* CSS de login */
    #login-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: #f0f2f5; display: flex; justify-content: center; align-items: center;
      z-index: 1000;
    }
    #login-form {
      background-color: #fff; padding: 30px; border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center;
    }
    #login-form input {
      padding: 10px; margin: 10px 0; width: 250px; border: 1px solid #ccc; border-radius: 4px;
    }
    #password-container { position: relative; }
    #password-container button {
      position: absolute; right: 5px; top: 50%; transform: translateY(-50%);
      background: none; border: none; cursor: pointer; font-size: 1.2rem;
    }
    #login-button {
      background-color: #007bff; color: white; border: none;
      padding: 12px 20px; border-radius: 4px; cursor: pointer;
      font-size: 1rem; width: 100%;
    }
    #login-button:hover { background-color: #0056b3; }
    #error-message { color: red; margin-top: 10px; font-size: 0.9rem; display: none; }

    /* CSS principal */
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, sans-serif; background-color: #fff; color: #000; }
    .container { display: flex; flex-direction: column; }
    @media (min-width: 768px) { .container { flex-direction: row; min-height: 100vh; } }
    .left-panel, .right-panel { padding: 20px; }
    .left-panel { flex: 2; border-right: 1px solid #ccc; }
    .right-panel { flex: 1; }
    .calendar-section { margin: 20px 0; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .day-nav { display: flex; gap: 8px; align-items: center; margin: -10px 0 10px 0; }
    .actions { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    .search-area { display: flex; gap: 5px; margin-bottom: 10px; align-items: center; flex-wrap: wrap; }
    .commitment { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; flex-wrap: wrap; padding: 5px; }
    .done { text-decoration: line-through; color: gray; }
    .commitment.checked { background-color: #d1e7ff; }
    .commitment:nth-child(even) { background-color: #f2f2f2; }
    .commitment:nth-child(even).checked { background-color: #aed6f1; }
    #cpfStatus.valid { color: blue; }
    #cpfStatus.invalid { color: red; }
  </style>

  <!-- Firebase Compat -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
  <!-- Tela de Login -->
  <div id="login-screen">
    <div id="login-form">
      <h2 id="login-title">Acesso Restrito</h2>
      <div id="password-container">
        <input type="password" id="password-input" placeholder="Digite a senha" onkeypress="handleKeyPress(event)">
        <button id="toggle-password" onclick="togglePasswordVisibility()">üëÅÔ∏è</button>
      </div>
      <p id="error-message">Senha incorreta. Tente novamente.</p>
      <button id="login-button" onclick="checkPassword()">Entrar</button>
      <div id="setup-message" style="display: none; margin-top: 15px;">
        <p>Ainda n√£o h√° senha. Defina uma para continuar.</p>
        <button id="set-password-button" onclick="setPassword()">Definir Senha</button>
      </div>
    </div>
  </div>

  <!-- Conte√∫do principal -->
  <div class="container" id="main-content" style="display: none;">
    <div class="left-panel">
      <h1>Agenda da Val</h1>
      <div class="calendar-section">
        <input type="date" id="dataSelecionada">
        <button id="hojeBtn" title="Hoje">üìÖ</button>
      </div>
      <div class="day-nav">
        <button id="prevDayBtn" title="Dia anterior">‚óÄ</button>
        <button id="nextDayBtn" title="Pr√≥ximo dia">‚ñ∂</button>
      </div>
      <div class="actions">
        <button id="novoBtn">Novo</button>
        <button id="copiarBtn">Copiar</button>
        <button id="colarBtn">Colar</button>
        <button id="exportarBtn">Exportar TXT</button>
      </div>
      <div id="agenda"></div>
    </div>
    <div class="right-panel">
      <h3>üîç Pesquisa</h3>
      <div class="search-area">
        <input type="text" id="search" placeholder="Pesquisar...">
        <button onclick="limparBusca()">‚ùå</button>
      </div>
      <div id="searchResults" class="search-results"></div>
      <h3>üìù Lembretes:</h3>
      <textarea id="notasFixas" rows="15" style="width: 100%; resize: vertical;"></textarea>
    </div>
  </div>

<script>
  /* ======== CONFIG FIREBASE ======== */
  const firebaseConfig = {
    apiKey: "AIzaSyBiikcagIm1p7wJG6DsHijkvdy1fpDBn8Y",
    authDomain: "bd-teste-c931c.firebaseapp.com",
    databaseURL: "https://bd-teste-c931c-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "bd-teste-c931c",
    storageBucket: "bd-teste-c931c.firebasestorage.app",
    messagingSenderId: "270308100761",
    appId: "1:270308100761:web:ae34fde6d5ae86b67b0608"
  };
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  /* ======== LOGIN ======== */
  const PASSWORD_NODE = 'appPassword';
  const mainContent = document.getElementById('main-content');
  const loginScreen = document.getElementById('login-screen');
  const passwordInput = document.getElementById('password-input');
  const errorMessage = document.getElementById('error-message');
  const togglePasswordBtn = document.getElementById('toggle-password');
  const setupMessage = document.getElementById('setup-message');
  const loginTitle = document.getElementById('login-title');
  let correctPassword = null;

  async function loadPassword() {
    const snapshot = await database.ref(PASSWORD_NODE).once('value');
    correctPassword = snapshot.val();
    if (correctPassword) {
      setupMessage.style.display = 'none';
    } else {
      setupMessage.style.display = 'block';
      document.getElementById('login-button').style.display = 'none';
      passwordInput.placeholder = 'Defina uma senha';
    }
    loginScreen.style.display = 'flex';
  }
  function setPassword() {
    if (passwordInput.value.trim()) {
      database.ref(PASSWORD_NODE).set(passwordInput.value).then(() => {
        alert('Senha definida!');
        loadPassword();
        passwordInput.value = '';
      });
    }
  }
  function checkPassword() {
    if (passwordInput.value === correctPassword) {
      showMainContent();
    } else {
      errorMessage.style.display = 'block';
    }
  }
  function togglePasswordVisibility() {
    passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
  }
  function handleKeyPress(e) {
    if (e.key === 'Enter') {
      correctPassword ? checkPassword() : setPassword();
    }
  }
  function showMainContent() {
    loginScreen.style.display = 'none';
    mainContent.style.display = 'flex';
    carregarAgenda();
    carregarNotasFixas();
    requestNotificationPermission();
    setInterval(verificarLembretes, 30000);
  }
  window.addEventListener('load', loadPassword);

  /* ======== FUN√á√ÉO NOTIFICA√á√ÉO ======== */
  function requestNotificationPermission() {
    if ('Notification' in window) {
      Notification.requestPermission();
    }
  }
  function sendNotification(titulo, corpo) {
    if (Notification.permission === 'granted') {
      new Notification(titulo, { body: corpo });
    } else {
      alert(`${titulo}: ${corpo}`);
    }
  }

  /* ======== LEMBRETES COM NOTIFICA√á√ÉO ======== */
  function verificarLembretes() {
    const hoje = new Date().toISOString().split('T')[0];
    if (dataInput.value !== hoje) return;

    const agora = new Date();
    const horaAtual = agora.getHours().toString().padStart(2, '0') + ':' + agora.getMinutes().toString().padStart(2, '0');

    document.querySelectorAll('.commitment').forEach(div => {
      const texto = div.querySelector('input[type="text"]').value.trim();
      const hora = div.querySelector('input[type="time"]').value;
      const check = div.querySelector('.lembrete-checkbox');
      if (check.checked && hora && horaAtual >= hora && texto) {
        sendNotification('LEMBRETE', texto);
        check.checked = false;
        salvarAgenda();
      }
    });
  }

  /* ======== AGENDA ======== */
  const dataInput = document.getElementById('dataSelecionada');
  const agendaEl = document.getElementById('agenda');
  const novoBtn = document.getElementById('novoBtn');
  dataInput.value = new Date().toISOString().split('T')[0];
  novoBtn.onclick = () => document.querySelector('.commitments').appendChild(criarCampoCompromisso());

  async function carregarAgenda() {
    const data = dataInput.value;
    agendaEl.innerHTML = '';
    const compromissosDiv = document.createElement('div');
    compromissosDiv.className = 'commitments';
    const snap = await database.ref('agenda/' + data).once('value');
    let dados = snap.val() || [];
    while (dados.length < 15) dados.push({ texto: '', hora: '', selecionado: false, lembreteAtivo: false });
    dados.forEach(item => compromissosDiv.appendChild(criarCampoCompromisso(item)));
    agendaEl.appendChild(compromissosDiv);
  }
  function salvarAgenda() {
    const data = dataInput.value;
    const arr = [];
    document.querySelectorAll('.commitment').forEach(div => {
      arr.push({
        texto: div.querySelector('input[type="text"]').value,
        hora: div.querySelector('input[type="time"]').value,
        selecionado: div.querySelector('input[type="checkbox"]').checked,
        lembreteAtivo: div.querySelector('.lembrete-checkbox').checked
      });
    });
    database.ref('agenda/' + data).set(arr);
  }
  function criarCampoCompromisso(item = {}) {
    const div = document.createElement('div');
    div.className = 'commitment';
    const check = document.createElement('input');
    check.type = 'checkbox'; check.checked = item.selecionado || false;
    const txt = document.createElement('input');
    txt.type = 'text'; txt.value = item.texto || '';
    const hora = document.createElement('input');
    hora.type = 'time'; hora.value = item.hora || '';
    const lembrete = document.createElement('input');
    lembrete.type = 'checkbox'; lembrete.className = 'lembrete-checkbox'; lembrete.checked = item.lembreteAtivo || false; lembrete.style.display = 'none';
    const label = document.createElement('label');
    label.textContent = 'üîî'; label.setAttribute('for', 'lembrete-' + Math.random());
    label.onclick = () => { lembrete.checked = !lembrete.checked; salvarAgenda(); };
    div.append(check, txt, hora, lembrete, label);
    return div;
  }

  /* ======== NOTAS FIXAS ======== */
  const notasFixasEl = document.getElementById('notasFixas');
  async function carregarNotasFixas() {
    const snap = await database.ref('notasFixas').once('value');
    notasFixasEl.value = snap.val() || '';
  }
  notasFixasEl.oninput = () => database.ref('notasFixas').set(notasFixasEl.value);
</script>
</body>
</html>
